<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>wasu's comic library</title>
    <link rel="icon" type="image/png" href="https://emojipedia-us.s3.dualstack.us-west-1.amazonaws.com/thumbs/240/twitter/322/open-book_1f4d6.png">
    <style>
        body {
            background-color: bisque;
            color: darkslategray;
        }
        p#demo img {
            width: 200px;
        }

        #demo {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-end;
            justify-content: center;
            text-align: center;
            font-weight: bold;
        }

        #demo div {
            width: 220px;
            height: auto;
            margin: 5px;
            padding: 5px;
            padding-top: 15px;
        }

        #demo div:hover {
            background-color:lightsteelblue;
        }

        #progressbar {
            width: 0;
            position: fixed;
            top: 0;
            left: 0;
            border-top: 5px solid #00B0F0;
        }
        
    </style>
</head>

<body>
    <div id="progressbar"></div>
    <p id="demo"></p>

    <script>

        async function fetchComics() {
            const response = await fetch('https://api.github.com/repos/wsu808/wsu_cubari/contents/');
            const comicLinks = await response.json();
            for (var i = 0; i < comicLinks.length; i++) {
                var cubariLink = getCubariURL(comicLinks[i].download_url);
                var elem = '<a href="' + cubariLink + '" target="_blank">' + '<div>'; 
                if (comicLinks[i].name.includes(".json")) {
                    const cvr = await getCoverURL(comicLinks[i].download_url);
                    elem += '<img src="' + cvr + '">' + '<br>';
                } else {
                    elem += "not a comic file" + '<br>';
                }
                elem += comicLinks[i].name + '</div></a>';
                document.getElementById('demo').innerHTML += elem;
                //progressbar
                var progress = i*100/comicLinks.length;
                if(progress>95) {
                    document.getElementById('progressbar').style.display = 'none';
                } else {
                    document.getElementById('progressbar').style.width = i*100/comicLinks.length + '%';
                }
                
            }
        }
        fetchComics().then(data => { data })

        function getCubariURL(URL) {
            var cubariLink = URL.replace('https://raw.githubusercontent.com', '');
            cubariLink = 'raw' + cubariLink;
            cubariLink = btoa(cubariLink);
            cubariLink = 'https://cubari.moe/read/gist/' + cubariLink;
            return cubariLink;
        }

        async function getCoverURL(fileURL) {
            var cvrURL = '';
            const response = await fetch(fileURL);
            const data = await response.json();
            return data.cover ? data.cover : 'https://via.placeholder.com/512x768.jpg?text=<no_cover>' ;
        }



    </script>

</body>

</html>
